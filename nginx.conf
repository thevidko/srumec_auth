events {}

http {
    # Definice upstreamů (názvy služeb z docker-compose)
    upstream auth_upstream {
        server auth-service:8000;
    }

    upstream events_upstream {
        server events-service:4000;
    }

    upstream chats_upstream {
        # Uvnitř Docker sítě poslouchá chats-service na 4000 (ne 4001, to je vnější port)
        server chats-service:4000;
    }

    server {
        listen 80;

        # --- 1. Auth Service ---
        # ZMĚNA: Odstraněn rewrite. Používáme proxy_pass s lomítkem na konci.
        # Nginx automaticky "ukousne" /auth/ a pošle zbytek na službu.
        location /auth/ {
            proxy_pass http://auth_upstream/;  # <--- To lomítko je DŮLEŽITÉ
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # --- 2. Interní validační endpoint (volá Nginx sám) ---
        location = /_auth_validate {
            internal; # Nelze zavolat zvenčí
            
            # Pošle dotaz na /validate v auth-service
            proxy_pass http://auth_upstream/validate;
            
            # Neposíláme tělo požadavku (šetříme data), zajímá nás jen hlavička Authorization
            proxy_pass_request_body off;
            proxy_set_header Content-Length "";
            proxy_set_header X-Original-URI $request_uri;
        }

        # --- 3. Chráněné služby ---

        # EVENTS SERVICE
        location /v1/events/ {
            # Tady je ta magie: Nejdřív se zeptej /_auth_validate
            auth_request /_auth_validate;

            proxy_pass http://events_upstream;
            
            # Předání hlaviček
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header Authorization $http_authorization; # Předáme token dál
        }
        location /v1/comments/ {
            auth_request /_auth_validate;
            # Směrujeme na events_upstream
            proxy_pass http://events_upstream;

            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header Authorization $http_authorization;
        }

        location /comments/ {
            auth_request /_auth_validate;
            proxy_pass http://events_upstream;

            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header Authorization $http_authorization;
        }

        # CHATS SERVICE
        location /v1/chats/ {
            auth_request /_auth_validate;

            
            proxy_pass http://chats_upstream;
            
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header Authorization $http_authorization;
        }
    }
}
