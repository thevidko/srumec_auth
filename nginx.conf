events {}

http {
    # Definice upstreamů (názvy služeb z docker-compose)
    upstream auth_upstream {
        server auth-service:8000;
    }

    upstream events_upstream {
        server events-service:4000;
    }

    upstream chats_upstream {
        # Uvnitř Docker sítě poslouchá chats-service na 4000 (ne 4001, to je vnější port)
        server chats-service:4000;
    }

    upstream ws_node_upstream {
        server ws-service:4000;   # název služby z docker-compose
    }


    server {
        listen 80;

        # --- 1. Auth Service ---
        # ZMĚNA: Odstraněn rewrite. Používáme proxy_pass s lomítkem na konci.
        # Nginx automaticky "ukousne" /auth/ a pošle zbytek na službu.
        location /auth/ {
            proxy_pass http://auth_upstream/;  # <--- To lomítko je DŮLEŽITÉ
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        location /auth/users/ {
            # DŮLEŽITÉ: Zde nepoužíváme "auth_request /_auth_validate". Validuje si sama
            proxy_pass http://auth_upstream;

            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            proxy_set_header Authorization $http_authorization;
        }

        # --- 2. Interní validační endpoint (volá Nginx sám) ---
        location = /_auth_validate {
            internal; # Nelze zavolat zvenčí

            # Pošle dotaz na /validate v auth-service
            proxy_pass http://auth_upstream/validate;

            # Neposíláme tělo požadavku (šetříme data), zajímá nás jen hlavička Authorization
            proxy_pass_request_body off;
            proxy_set_header Content-Length "";
            proxy_set_header X-Original-URI $request_uri;
        }

        location = /_auth_validate_jwt_url_arg {
            internal;
            proxy_pass http://auth_upstream/validate;

            proxy_http_version 1.1;       # ← ABSOLUTNĚ DŮLEŽITÉ
            proxy_pass_request_body off;
            proxy_set_header Content-Length "";

            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            proxy_set_header Authorization "Bearer $auth_token_from_url";
        }

        # --- Nechráněné služby (dokumentace) ---

        location /ws/docs/ {
            proxy_pass http://ws-service:4001/ws/docs/;
        }

        location /v1/events/docs {
            proxy_pass http://events_upstream/v1/events/docs;
        }
        location /v1/events/docs-swagger {
            proxy_pass http://events_upstream/v1/events/docs-swagger;
        }
        location /v1/events/docs-raw {
            proxy_pass http://events_upstream/v1/events/docs-raw;
        }

        location /v1/chats/docs {
            proxy_pass http://chats_upstream/v1/chats/docs;
        }
        location /v1/chats/docs-swagger {
            proxy_pass http://chats_upstream/v1/chats/docs-swagger;
        }
        location /v1/chats/docs-raw {
            proxy_pass http://chats_upstream/v1/chats/docs-raw;
        }

        # --- 3. Chráněné služby ---

        # EVENTS SERVICE
        location /v1/events/ {
            # Tady je ta magie: Nejdřív se zeptej /_auth_validate
            auth_request /_auth_validate;

            proxy_pass http://events_upstream;

            # Předání hlaviček
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header Authorization $http_authorization; # Předáme token dál
        }
        location /v1/comments/ {
            auth_request /_auth_validate;
            # Směrujeme na events_upstream
            proxy_pass http://events_upstream;

            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header Authorization $http_authorization;
        }

        location /comments/ {
            auth_request /_auth_validate;
            proxy_pass http://events_upstream;

            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header Authorization $http_authorization;
        }

        # CHATS SERVICE
        location /v1/chats/ {
            auth_request /_auth_validate;


            proxy_pass http://chats_upstream;

            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header Authorization $http_authorization;
        }

        location = /ws {
            # Uložíme si token z query do vlastní proměnné
            set $auth_token_from_url $arg_token;

            # JWT validace přes auth-service (použije $auth_token_from_url)
            auth_request /_auth_validate_jwt_url_arg;

            error_page 401 = @error401;
            error_page 403 = @error403;

            proxy_pass http://ws_node_upstream;

            proxy_http_version 1.1;
            proxy_set_header Upgrade    $http_upgrade;
            proxy_set_header Connection "upgrade";

            # Stejný token pošleme i do WS služby
            proxy_set_header Authorization "Bearer $auth_token_from_url";

            proxy_read_timeout 600s;
            proxy_send_timeout 600s;
        }

        location @error401 { return 401; }
        location @error403 { return 403; }
    }
}
